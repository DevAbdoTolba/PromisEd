<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your course completion certificate">
    <title>Certificate - PromisEd</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/student.css">
    <style>
        @media print {
            .no-print, .main-nav { display: none !important; }
            .certificate { box-shadow: none !important; margin: 0 !important; }
            .container { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body>
    <script src="../js/storage.js"></script>
    <script src="../js/navbar.js"></script>

    <div class="container mt-3">
        <div class="no-print mb-2">
            <a href="dashboard.html" class="text-muted">&larr; Back to Dashboard</a>
        </div>

        <div class="certificate" id="certificate">
            <div class="cert-border">
                <div class="cert-inner">
                    <div class="cert-logo">ðŸŽ“</div>
                    <h1 class="cert-title">Certificate of Completion</h1>
                    <p class="cert-subtitle">This is to certify that</p>
                    <h2 class="cert-name" id="cert-name">Student Name</h2>
                    <p class="cert-text">has successfully completed the course</p>
                    <h3 class="cert-course" id="cert-course">Course Title</h3>
                    <p class="cert-text">on PromisEd Learning Platform</p>
                    <div class="cert-date">
                        <span id="cert-date">Date</span>
                    </div>
                    <div class="cert-signature">
                        <div class="cert-sig-line"></div>
                        <p>Platform Director</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-2 no-print">
            <button onclick="window.print()" class="btn btn-primary">Print Certificate</button>
            <a href="dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <script>
        (function() {
            var user = DB.users.getLoggedIn();
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            var urlParams = new URLSearchParams(window.location.search);
            var courseId = urlParams.get('course');

            if (!courseId) {
                alert('Invalid certificate request');
                window.location.href = 'dashboard.html';
                return;
            }

            // Security Check: Verify course completion
            var enrollment = user.enrolledCourses.find(function(e) { return e.courseId == courseId; });
            
            if (!enrollment || enrollment.progress < 100) {
                alert('You must complete the course to view the certificate.');
                window.location.href = 'dashboard.html';
                return;
            }

            var course = DB.courses.getById(courseId);
            if (!course) {
                alert('Course not found');
                window.location.href = 'dashboard.html';
                return;
            }

            // Populate certificate
            document.getElementById('cert-name').textContent = user.name;
            document.getElementById('cert-course').textContent = course.title;
            
            // Use the actual completion date, not today's date
            var completionDate = enrollment.completedDate ? new Date(enrollment.completedDate) : new Date();
            var dateStr = completionDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('cert-date').textContent = dateStr;
        })();
    </script>
</body>
</html>
